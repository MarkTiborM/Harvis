---
# GitLab Runner Deployment - Node 1 (pop-os) for Backend Builds
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab-runner-node1
  namespace: gitlab-runner
  labels:
    app.kubernetes.io/name: gitlab-runner
    app.kubernetes.io/component: ci-cd
    app.kubernetes.io/instance: node1
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: gitlab-runner
      app.kubernetes.io/instance: node1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: gitlab-runner
        app.kubernetes.io/instance: node1
    spec:
      serviceAccountName: gitlab-runner
      # Force scheduling on Node 1 (pop-os) - control plane with RTX 4090
      nodeSelector:
        kubernetes.io/hostname: pop-os

      containers:
        - name: gitlab-runner
          image: gitlab/gitlab-runner:latest
          imagePullPolicy: Always

          env:
            # Runner configuration
            - name: RUNNER_NAME
              value: "harvis-k8s-node1-backend"
            - name: RUNNER_EXECUTOR
              value: "docker"
            - name: DOCKER_HOST
              value: "unix:///var/run/docker.sock"
            - name: RUNNER_TAG_LIST
              value: "node1,backend,gpu,docker"
            - name: REGISTER_NON_INTERACTIVE
              value: "true"

            # GitLab instance config (from secret)
            - name: CI_SERVER_URL
              valueFrom:
                secretKeyRef:
                  name: gitlab-runner-secret
                  key: gitlab-url
            - name: REGISTRATION_TOKEN
              valueFrom:
                secretKeyRef:
                  name: gitlab-runner-secret
                  key: registration-token

          # Mount Docker socket for Docker executor
          volumeMounts:
            - name: docker-socket
              mountPath: /var/run/docker.sock
            - name: gitlab-runner-config
              mountPath: /etc/gitlab-runner
            - name: runner-cache
              mountPath: /cache

          resources:
            requests:
              memory: 2Gi
              cpu: 1000m
            limits:
              memory: 4Gi
              cpu: 2000m

          livenessProbe:
            exec:
              command:
                - /usr/bin/pgrep
                - gitlab-runner
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10

          readinessProbe:
            exec:
              command:
                - /usr/bin/pgrep
                - gitlab-runner
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5

      volumes:
        # Docker socket for Docker-in-Docker builds
        - name: docker-socket
          hostPath:
            path: /var/run/docker.sock
            type: Socket

        # GitLab Runner configuration
        - name: gitlab-runner-config
          configMap:
            name: gitlab-runner-config

        # Cache for build artifacts
        - name: runner-cache
          emptyDir: {}

---
# GitLab Runner Deployment - Node 2 (pop-os-343570d8) for Frontend/General Builds
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab-runner-node2
  namespace: gitlab-runner
  labels:
    app.kubernetes.io/name: gitlab-runner
    app.kubernetes.io/component: ci-cd
    app.kubernetes.io/instance: node2
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: gitlab-runner
      app.kubernetes.io/instance: node2
  template:
    metadata:
      labels:
        app.kubernetes.io/name: gitlab-runner
        app.kubernetes.io/instance: node2
    spec:
      serviceAccountName: gitlab-runner
      # Force scheduling on Node 2 (pop-os-343570d8) - worker with RTX 3090 Ti
      nodeSelector:
        kubernetes.io/hostname: pop-os-343570d8

      containers:
        - name: gitlab-runner
          image: gitlab/gitlab-runner:latest
          imagePullPolicy: Always

          env:
            # Runner configuration
            - name: RUNNER_NAME
              value: "harvis-k8s-node2-frontend"
            - name: RUNNER_EXECUTOR
              value: "docker"
            - name: DOCKER_HOST
              value: "unix:///var/run/docker.sock"
            - name: RUNNER_TAG_LIST
              value: "node2,frontend,docker"
            - name: REGISTER_NON_INTERACTIVE
              value: "true"

            # GitLab instance config (from secret)
            - name: CI_SERVER_URL
              valueFrom:
                secretKeyRef:
                  name: gitlab-runner-secret
                  key: gitlab-url
            - name: REGISTRATION_TOKEN
              valueFrom:
                secretKeyRef:
                  name: gitlab-runner-secret
                  key: registration-token

          # Mount Docker socket for Docker executor
          volumeMounts:
            - name: docker-socket
              mountPath: /var/run/docker.sock
            - name: gitlab-runner-config
              mountPath: /etc/gitlab-runner
            - name: runner-cache
              mountPath: /cache

          resources:
            requests:
              memory: 2Gi
              cpu: 1000m
            limits:
              memory: 4Gi
              cpu: 2000m

          livenessProbe:
            exec:
              command:
                - /usr/bin/pgrep
                - gitlab-runner
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10

          readinessProbe:
            exec:
              command:
                - /usr/bin/pgrep
                - gitlab-runner
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5

      volumes:
        # Docker socket for Docker-in-Docker builds
        - name: docker-socket
          hostPath:
            path: /var/run/docker.sock
            type: Socket

        # GitLab Runner configuration
        - name: gitlab-runner-config
          configMap:
            name: gitlab-runner-config

        # Cache for build artifacts
        - name: runner-cache
          emptyDir: {}

---
# Service for GitLab Runner metrics (optional)
apiVersion: v1
kind: Service
metadata:
  name: gitlab-runner-metrics
  namespace: gitlab-runner
  labels:
    app.kubernetes.io/name: gitlab-runner
    app.kubernetes.io/component: ci-cd
spec:
  type: ClusterIP
  ports:
    - name: metrics
      port: 9252
      targetPort: 9252
      protocol: TCP
  selector:
    app.kubernetes.io/name: gitlab-runner
